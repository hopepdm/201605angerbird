function init3DSection(){function o(o){o.preventDefault();var t=o.touches[0];y=t.screenX,k=t.screenY}function t(o){o.preventDefault();var t=o.touches[0];v-=.2*(t.screenX-y),w+=.2*(t.screenY-k),y=t.screenX,k=t.screenY}function e(){camera.aspect=window.innerWidth/window.innerHeight,camera.updateProjectionMatrix(),g.setSize(window.innerWidth,window.innerHeight)}function i(){v+=90===v?1:0,g.render(n,camera),DeviceOrientation?controls.update():(w=Math.max(-85,Math.min(85,w)),_=THREE.Math.degToRad(90-w),S=THREE.Math.degToRad(v),T.x=Math.sin(_)*Math.cos(S),T.y=Math.cos(_),T.z=Math.sin(_)*Math.sin(S),_shotTarget=[1e3*T.x.toFixed(3),1e3*T.y.toFixed(3),1e3*T.z.toFixed(3)],camera.lookAt(T)),requestAnimationFrame(i)}camera=new THREE.PerspectiveCamera(90,$(window).width()/$(window).height(),10,150),camera.fov=103,controls=new THREE.DeviceOrientationControls(camera),controls.connect();for(var n=new THREE.Scene,s=Math.PI,a=s/2,r=[{url:"../img/scene_3d/posx-1024.png",position:[-512,0,0],rotation:[0,a,0]},{url:"../img/scene_3d/negx-1024.png",position:[512,0,0],rotation:[0,-a,0]},{url:"../img/scene_3d/posy-1024.png",position:[0,512,0],rotation:[a,0,s]},{url:"../img/scene_3d/negy-1024.png",position:[0,-512,0],rotation:[-a,0,s]},{url:"../img/scene_3d/posz-1024.png",position:[0,0,512],rotation:[0,s,0]},{url:"../img/scene_3d/negz-1024.png",position:[0,0,-512],rotation:[0,0,0]}],c=0;c<r.length;c++){var l=r[c],d=document.createElement("img");d.src=l.url,d.className="section3D",d.id="section3D-"+c;var u=new THREE.CSS3DObject(d);u.position.fromArray(l.position),u.rotation.fromArray(l.rotation),n.add(u);var h=document.createElement("img");if(h.width=136,h.src="../img/target/clock.png",h.className="clock",h.id="clock-"+c,0===c||1===c||4===c||5===c){var p=new THREE.CSS3DObject(h);switch(p.position.fromArray(l.position),p.rotation.fromArray(l.rotation),c){case 0:p.position.fromArray([-512,0,-185]);break;case 1:p.position.fromArray([512,-350,300]);break;case 4:p.position.fromArray([-135,-30,512]);break;case 5:p.position.fromArray([80,-70,-512])}n.add(p)}var m=document.createElement("img");if(m.width=41,m.src="../img/target/milk-"+Math.floor(2*Math.random()+1)+".png",m.className="milk",m.id="milk-"+c,0===c||1===c||4===c||5===c){var f=new THREE.CSS3DObject(m);switch(f.position.fromArray(l.position),f.rotation.fromArray(l.rotation),c){case 0:f.position.fromArray([-512,-10,-80]);break;case 1:f.position.fromArray([502,-60,-345]);break;case 4:f.position.fromArray([-235,-45,512]);break;case 5:f.position.fromArray([190,-75,-512])}n.add(f)}}var g=new THREE.CSS3DRenderer;g.setSize($(window).width(),$(window).height()),$("#quanjing").append(g.domElement);var y,k,v=90,w=0,_=0,S=0,C=document.getElementById("quanjing");DeviceOrientation||(C.addEventListener("touchstart",o,!1),C.addEventListener("touchmove",t,!1)),window.addEventListener("resize",e,!1);var T=new THREE.Vector3;i()}function checkShotTarget(o){var t=!1;console.log("发射落点："+o[0]+", "+o[1]+", "+o[2]);for(pig in _clockPosition)for(key in _clockPosition[pig]){var e=o[0]>=_clockPosition[pig].x[0]&&o[0]<=_clockPosition[pig].x[1],i=o[1]>=_clockPosition[pig].y[0]&&o[1]<=_clockPosition[pig].y[1],n=o[2]>=_clockPosition[pig].z[0]&&o[2]<=_clockPosition[pig].z[1];if(console.log("是否命中？ x:"+e+", y: "+i+", z: "+n),e&&i&&n&&!_clockPosition[pig].hited)return _finished.hit+=1,$("#"+pig).addClass("none"),showFullTips("tips-hit-"+Math.floor(3*Math.random()+0),function(){}),t=!0,!1}t||showFullTips("tips-nohit-"+Math.floor(2*Math.random()+0),function(){})}function checkShotTarget4(o){var t=!1;console.log("发射落点："+o[0]+", "+o[1]+", "+o[2],", "+o[3]);for(pig in _clockPosition4)for(key in _clockPosition4[pig]){var e=Math.abs(o[1])>=Math.abs(_clockPosition4[pig].y[0])&&Math.abs(o[1])<=Math.abs(_clockPosition4[pig].y[1]),i=Math.abs(o[3])>=Math.abs(_clockPosition4[pig].w[0])&&Math.abs(o[3])<=Math.abs(_clockPosition4[pig].w[1]);if(console.log("是否命中？ x:, y: "+e+", z: , w: "+i),e&&i&&!_clockPosition4[pig].hited)return _finished.hit+=1,$("#"+pig).addClass("none"),showFullTips("tips-hit-"+Math.floor(3*Math.random()+0)),t=!0,!1}t||showFullTips("tips-nohit-"+Math.floor(2*Math.random()+0))}function openEyes(o){setTimeout(function(){$("#open-eyes").addClass("nobg");var t=-1,e=self.setInterval(function(){t+=1,$("#open-eyes img").addClass("none"),$("#open-eyes img").eq(t).removeClass("none"),t>=36&&(e=window.clearInterval(e),setTimeout(function(){$("#open-eyes").addClass("none"),"function"==typeof o&&o.call(this)},62.5))},62.5)},500)}function initShot(){console.log("初始化弹弓"),$("#shot").addClass("show");for(key in _clipStatus)_clipStatus[key].current&&$("#shot-bird").attr("class","").addClass(key);var o=$("#shot")[0],t=new Hammer(o);t.get("pan").set({direction:Hammer.DIRECTION_ALL}),t.on("panmove",function(o){o.deltaY>40&&""!=$("#shot-bird").attr("class")&&$("#shot-trigger").removeClass("off").addClass("on")}),t.on("panstart",function(o){audioPush||(audioPush=document.createElement("audio"),audioPush.src="../img/push.mp3",audioPush.loop=!1),audioPush.play()}),t.on("panend",function(o){console.log("下拉触发：",o.deltaY),checkEmpty(),o.deltaY>40&&""!=$("#shot-bird").attr("class")&&(audioPush.pause(),audioPush.currentTime=0,audioShot||(audioShot=document.createElement("audio"),audioShot.src="../img/shot.mp3",audioShot.loop=!1),audioShot.play(),$("#shot-tips").hide(),$("#shot-trigger").addClass("off").removeClass("on"),$("#shot-bird").addClass("flying"),setTimeout(function(){var o=$("#shot-bird").attr("class").split(" ")[0];_clipStatus[o].empty=!0,_clipStatus[o].current=!1,$("#clip > .clip-item").removeClass("current");for(key in _clipStatus)_clipStatus[key].empty&&$("#clip > ."+key).addClass("empty");_finished.used+=1,$("#shot-bird").attr("class",""),chargeBird(),DeviceOrientation?checkShotTarget4(_shotTarget4):checkShotTarget(_shotTarget),checkGame()},500))})}function initClip(){console.log("初始化弹夹"),$("#clip").addClass("show");for(key in _clipStatus)_clipStatus[key].current&&$("#clip > ."+key).addClass("current")}function chargeBird(){console.log("给弹弓装弹");for(key in _clipStatus)if(!_clipStatus[key].empty)return console.log("下个子弹："+key),_clipStatus[key].current=!0,$("#shot-bird").attr("class",""),$("#shot-bird").addClass(key),!1}function initMilk(){console.log("初始化奶资源");var o=Math.floor(4*Math.random()+0);console.log("本次的空奶："+o),$(".milk").each(function(t,e){t==o?$(this).data("empty","true"):$(this).data("empty","false")}).on("touchstart",function(o){o.preventDefault(),getMilk($(this))})}function getMilk(o){var t="true"==o.data("empty");if(t)showFullTips("tips-empty-0"),console.log("这是一罐空奶，删除奶盒"+o.attr("id")),o.addClass("none");else{var e=!(_clipStatus["shot-bird-red"].empty||_clipStatus["shot-bird-black"].empty||_clipStatus["shot-bird-yellow"].empty);if(e)showFullTips("tips-full-0");else for(key in _clipStatus)if(_clipStatus[key].empty)return console.log(key+"弹为空，装填"),_clipStatus[key].empty=!1,$("#clip > ."+key).removeClass("empty"),""==$("#shot-bird").attr("class")&&($("#shot-bird").attr("class",key),$("#clip > ."+key).addClass("current")),console.log("装弹完成，删除奶盒"+o.attr("id")),o.addClass("none"),!1}}function checkGame(){console.log("命中数："+_finished.hit+"；已用子弹数："+_finished.used),_finished.hit>=4||_finished.used>=6?($("#tips-ajax-post").removeClass("none"),$.ajax({url:siteUrl+"/m/game_over",type:"POST",dataType:"json",data:{hit:_finished.hit}}).done(function(o){return"ok"!=o.info?(alert(o.info),!1):void(window.location.href=o.url)}).fail(function(o){alert("Sorry, 网络不给力")})):console.log("游戏尚未结束，命中数："+_finished.hit+"；已用子弹数："+_finished.used)}function checkEmpty(){var o=$("#clip > .empty").length;console.log("弹夹状态："+o),o>=3&&showFullTips("tips-empty-clip")}function showFullTips(o,t){$("#full-tips").removeClass("none"),$("#"+o).removeClass("none"),setTimeout(function(){hideFullTips(function(){"function"==typeof t&&t.call(this)})},2e3)}function hideFullTips(o){$("#full-tips").addClass("none"),$("#full-tips > div").addClass("none"),"function"==typeof o&&o.call(this)}var camera,controls;if($(".ios")[0]){var DeviceOrientation=!0;console.log("iOS系统，重力感应模式。")}else{var DeviceOrientation=!1;console.log("非iOS系统，拖拽模式")}var _shotTarget=[0,0,0],_shotTarget4=[0,0,0,0],_clockPosition={"clock-0":{hited:!1,x:[-873,-659],y:[341,604],z:[-552,-314]},"clock-1":{hited:!1,x:[656,822],y:[-155,54],z:[570,750]},"clock-4":{hited:!1,x:[-504,-243],y:[282,559],z:[709,925]},"clock-5":{hited:!1,x:[173,445],y:[222,490],z:[-972,-786]}},_clockPosition4={"clock-0":{hited:!1,y:[40,52],w:[80,87]},"clock-1":{hited:!1,y:[89,92],w:[38,45]},"clock-4":{hited:!1,y:[90,100],w:[15,30]},"clock-5":{hited:!1,y:[14,22],w:[95,98]}},audioPush,audioShot,_clipStatus={"shot-bird-red":{current:!0,empty:!1},"shot-bird-black":{current:!1,empty:!1},"shot-bird-yellow":{current:!1,empty:!1}},_finished={hit:0,used:0};$("#full-tips").on("touchend touchmove",function(o){o.preventDefault(),hideFullTips()}),$(function(){$(".form")[0]&&($(".form > form").css({height:$(window).height()}),$("body").css({"overflow-y":"auto"})),$("#pop-share")[0]&&($("#btn-share").on("touchend",function(o){o.preventDefault(),$("#pop-share").removeClass("none")}),$("#pop-share").on("touchend",function(o){o.preventDefault(),$("#pop-share").addClass("none")})),$("#quanjing")[0]&&(document.addEventListener("touchmove",function(o){o.preventDefault()}),init3DSection(),openEyes(function(){initShot(),initClip(),initMilk()}))}),$("#music")[0]&&(setTimeout(function(){$(window).scrollTop(1)},0),document.addEventListener("WeixinJSBridgeReady",function(){WeixinJSBridge.invoke("getNetworkType",{},function(o){document.getElementById("music").play()})},!1)),$("#bgmusic")[0]&&$("#bgmusic").on("click",function(o){o.preventDefault();var t=$("#music")[0],e=$(this);e.hasClass("on")?(e.removeClass("on").addClass("off"),t.pause()):(e.addClass("on").removeClass("off"),t.play())});